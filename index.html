<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css"
        integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
    <style>
        body {
            text-align: center;
        }

        #h_joystick {
            position: relative;
            box-sizing: content-box;
            margin-top: 100px;
        }

        #v_joystick {
            position: relative;
            box-sizing: content-box;
            margin-top: 100px;
        }
    </style>
    <meta charset="utf-8" />
    <script src="https://yoannmoi.net/nipplejs/javascripts/nipplejs.js"></script>

    <script type="text/javascript">

        function init() {

            x_component = 0;
            y_component = 0;

            speedLeft = 0;
            speedRight = 0;

            h_manager = nipplejs.create({
                zone: document.getElementById('h_joystick'),
                threshold: 0.1,
                position: { left: '50%', top: '50%' },
                mode: 'static',
                size: 150,
                color: '#000000',
                lockX: true
            });

            h_manager.on('move', function (event, nipple) {
                x_component = nipple.distance * Math.cos(nipple.angle.radian) / 75;
            });

            h_manager.on('end', function () {
                x_component = 0;
            });

            v_manager = nipplejs.create({
                zone: document.getElementById('v_joystick'),
                threshold: 0.1,
                position: { left: '50%', top: '50%' },
                mode: 'static',
                size: 150,
                color: '#000000',
                lockY: true
            });

            v_manager.on('move', function (event, nipple) {
                y_component = nipple.distance * Math.sin(nipple.angle.radian) / 75;
            });

            v_manager.on('end', function () {
                y_component = 0;
            });

            timer = setInterval(function () {
                move(x_component, y_component);
            }, 100);

            move = function (x_component, y_component) {
                $("#x_component").text(x_component);
                $("#y_component").text(y_component);

                new_speedLeft = 500 * y_component * (1 - x_component);
                if (y_component >= 0 && new_speedLeft > 500 * y_component || y_component <= 0 && new_speedLeft < 500 * y_component) {
                    new_speedLeft = 500 * y_component;
                }
                new_speedRight = 500 * y_component * (1 + x_component);
                if (y_component >= 0 && new_speedRight > 500 * y_component || y_component <= 0 && new_speedRight < 500 * y_component) {
                    new_speedRight = 500 * y_component;
                }

                if (Math.round(new_speedLeft) != speedLeft || Math.round(new_speedRight) != speedRight) {
                    speedLeft = Math.round(new_speedLeft);
                    speedRight = Math.round(new_speedRight);

                    $("#speed_left").text(speedLeft);
                    $("#speed_right").text(speedRight);

                    fetch('http://192.168.1.116/drive?speedLeft=' + speedLeft + '&speedRight=' + speedRight);
                }
            }

        }

        window.onload = function () {
            init();
        }

    </script>
</head>

<body>
    <div class="container">
        <h1>Roombot</h1>
        <div class="row">
            <div id="h_joystick" class="col-sm">
                <p id="x_component"></p>
                <p id="speed_left"></p>
            </div>
            <div id="v_joystick" class="col-sm">
                <p id="y_component"></p>
                <p id="speed_right"></p>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"
        integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI"
        crossorigin="anonymous"></script>
</body>

</html>